<template>
    <div class="hostel-booking">

        <!-- Header Banner -->
        <div class="header-banner">
            <h1 class="banner-title">{heading}</h1>
        </div>

        <!-- Flow (after booking) -->
        <template lwc:if={_showFlow}>
            <lightning-flow
                flow-api-name={flowApiName}
                flow-input-variables={_flowInputVariables}
                onstatuschange={handleFlowStatusChange}
            ></lightning-flow>
        </template>

        <!-- Main Content: Room List + Sidebar -->
        <template lwc:if={isShowingBooking}>
        <lightning-layout multiple-rows="true">

            <!-- Left Column: Room List -->
            <lightning-layout-item size="8" padding="around-small">

                <!-- Error -->
                <div class={errorClass} role="alert" aria-live="assertive" aria-atomic="true">
                    <template lwc:if={error}>
                        <span>{error}</span>
                    </template>
                </div>

                <!-- Loading -->
                <template lwc:if={isLoading}>
                    <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                </template>

                <!-- No Results -->
                <template lwc:if={hasNoResults}>
                    <div class="slds-text-align_center slds-p-vertical_large slds-text-color_weak">
                        No accommodations available for the selected dates and guest count.
                    </div>
                </template>

                <!-- Room Sections (Dorm Rooms / Private Rooms) -->
                <template for:each={roomSections} for:item="section">
                    <div key={section.key}>
                        <h2 class="section-header">{section.label}</h2>
                        <template for:each={section.rooms} for:item="room">
                            <div key={room.productId} class={room.cardClass}>
                                <!-- Room Row -->
                                <lightning-layout vertical-align="center" class="room-row">
                                    <!-- Select Button -->
                                    <lightning-layout-item class="slds-p-right_small">
                                        <lightning-button-stateful
                                            label-when-off="Add"
                                            label-when-on="Added"
                                            label-when-hover="Remove"
                                            icon-name-when-off="utility:add"
                                            icon-name-when-on="utility:check"
                                            icon-name-when-hover="utility:close"
                                            selected={room.isSelected}
                                            data-id={room.productId}
                                            onclick={handleToggleSelect}
                                        ></lightning-button-stateful>
                                    </lightning-layout-item>
                                    <!-- Name + Availability + Expand -->
                                    <lightning-layout-item flexibility="auto, grow" class="slds-p-horizontal_small">
                                        <h3 class="room-name">{room.name}</h3>
                                        <lightning-button-icon icon-name={room.chevronIcon} variant="bare" size="small" data-id={room.productId} onclick={handleToggleExpand} alternative-text={room.expandLabel}></lightning-button-icon>
                                        <span class={room.availClass}>{room.availLabel}</span>
                                    </lightning-layout-item>
                                    <!-- Price + Rate Basis -->
                                    <lightning-layout-item class="price-col slds-text-align_right">
                                        <span class="room-price">{room.formattedRate}</span>
                                        <div class="rate-subtext">from {room.formattedRate} {room.rateBasis}</div>
                                    </lightning-layout-item>
                                </lightning-layout>

                                <!-- Expanded Detail -->
                                <template lwc:if={room.isExpanded}>
                                    <div class="room-detail">
                                        <lightning-layout>
                                            <template lwc:if={room.hasImage}>
                                                <lightning-layout-item size="5" padding="around-small">
                                                    <img src={room.imageUrl} alt={room.name} class="room-image"/>
                                                </lightning-layout-item>
                                            </template>
                                            <lightning-layout-item flexibility="auto, grow" padding="around-small">
                                                <template lwc:if={room.hasAmenities}>
                                                    <ul class="amenities-list">
                                                        <template for:each={room.amenitiesList} for:item="amenity">
                                                            <li key={amenity.key}>{amenity.text}</li>
                                                        </template>
                                                    </ul>
                                                </template>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>

            </lightning-layout-item>

            <!-- Right Column: Sidebar -->
            <lightning-layout-item size="4" padding="around-small">
                <lightning-card title="Booking Details">
                    <div class="slds-p-horizontal_medium slds-p-bottom_medium">

                    <div class="slds-p-bottom_small">
                        <lightning-input
                            type="date"
                            label="Check in"
                            value={checkInDate}
                            min={datePickerMin}
                            max={datePickerMax}
                            onchange={handleCheckInChange}
                        ></lightning-input>
                    </div>
                    <div class="slds-p-bottom_small">
                        <lightning-input
                            type="date"
                            label="Check out"
                            value={checkOutDate}
                            min={datePickerMin}
                            max={datePickerMax}
                            onchange={handleCheckOutChange}
                        ></lightning-input>
                    </div>
                    <template lwc:if={hasDateError}>
                        <div class="slds-text-color_error slds-p-bottom_small slds-text-body_small">
                            {dateError}
                        </div>
                    </template>
                    <div class="slds-p-bottom_medium">
                        <lightning-combobox
                            label="Guests"
                            value={guestCount}
                            options={guestOptions}
                            onchange={handleGuestChange}
                        ></lightning-combobox>
                    </div>

                    <!-- Cart Items -->
                    <template lwc:if={hasCartItems}>
                        <template for:each={enrichedCartItems} for:item="item">
                            <div key={item.productId} class="cart-item">
                                <lightning-layout vertical-align="center" class="slds-m-bottom_x-small">
                                    <lightning-layout-item flexibility="auto, grow">
                                        <span class="cart-item-name">{item.name}</span>
                                    </lightning-layout-item>
                                    <lightning-layout-item>
                                        <lightning-button-icon icon-name="utility:close" variant="bare" size="x-small" class="cart-remove-btn" data-id={item.productId} onclick={handleRemoveItem} alternative-text={item.removeLabel}></lightning-button-icon>
                                    </lightning-layout-item>
                                </lightning-layout>
                                <lightning-layout vertical-align="center">
                                    <lightning-layout-item flexibility="auto, grow">
                                        <span class="cart-dates">{item.dateRange}</span>
                                    </lightning-layout-item>
                                    <lightning-layout-item>
                                        <span class="cart-nights">{item.nightCount}</span>
                                    </lightning-layout-item>
                                </lightning-layout>
                                <div class="cart-item-total-row">
                                    <lightning-layout vertical-align="end">
                                        <lightning-layout-item size="6">
                                            <lightning-combobox
                                                label={item.qtyFieldLabel}
                                                value={item.quantityStr}
                                                options={item.qtyOptions}
                                                data-id={item.productId}
                                                onchange={handleCartQuantityChange}
                                            ></lightning-combobox>
                                        </lightning-layout-item>
                                        <lightning-layout-item flexibility="auto, grow" class="slds-text-align_right">
                                            <span class="cart-item-price">{item.formattedTotal}</span>
                                        </lightning-layout-item>
                                    </lightning-layout>
                                    <div class="cart-qty-label">{item.qtyLabel}</div>
                                </div>
                            </div>
                        </template>

                        <!-- Cart Total -->
                        <lightning-layout class="cart-total-row" vertical-align="center">
                            <lightning-layout-item flexibility="auto, grow">
                                <span class="cart-total-label">Total</span>
                            </lightning-layout-item>
                            <lightning-layout-item>
                                <span class="cart-total-price">{formattedCartTotal}</span>
                            </lightning-layout-item>
                        </lightning-layout>
                    </template>

                    <!-- Book Now -->
                    <button class="slds-button slds-button_brand book-now-btn" onclick={handleBookNow} disabled={isBookNowDisabled}>
                        <template lwc:if={isBooking}>Booking...</template>
                        <template lwc:else>Book Now</template>
                    </button>
                    <template lwc:if={showBookNowHint}>
                        <p class="book-now-hint">Select at least one room to continue.</p>
                    </template>

                    </div>
                </lightning-card>
            </lightning-layout-item>

        </lightning-layout>
        </template>
    </div>
</template>
