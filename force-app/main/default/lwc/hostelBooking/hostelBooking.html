<template>
    <div class="hostel-booking">

        <!-- Progress Bar + Book Now -->
        <lightning-layout multiple-rows="true" vertical-align="center" class="header-bar">
            <lightning-layout-item size="8" padding="around-small">
                <lightning-progress-indicator current-step="1" type="path" variant="base">
                    <lightning-progress-step label="SELECT ROOMS" value="1"></lightning-progress-step>
                    <lightning-progress-step label="PROVIDE DETAILS" value="2"></lightning-progress-step>
                    <lightning-progress-step label="COMPLETE BOOKING" value="3"></lightning-progress-step>
                    <lightning-progress-step label="CONFIRM" value="4"></lightning-progress-step>
                </lightning-progress-indicator>
            </lightning-layout-item>
            <lightning-layout-item size="4" padding="around-small" class="slds-text-align_right">
                <button class={bookNowClass} onclick={handleBookNow} disabled={isBookNowDisabled}>
                    BOOK NOW
                </button>
            </lightning-layout-item>
        </lightning-layout>

        <!-- Main Content: Room List + Sidebar -->
        <lightning-layout multiple-rows="true">

            <!-- Left Column: Room List -->
            <lightning-layout-item size="8" padding="around-small">

                <!-- Error -->
                <template lwc:if={error}>
                    <div class="slds-notify slds-notify_alert slds-alert_error" role="alert">
                        <span>{error}</span>
                    </div>
                </template>

                <!-- Loading -->
                <template lwc:if={isLoading}>
                    <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                </template>

                <!-- No Results -->
                <template lwc:if={hasNoResults}>
                    <div class="slds-text-align_center slds-p-vertical_large slds-text-color_weak">
                        No accommodations available for the selected dates and guest count.
                    </div>
                </template>

                <!-- Room Sections (Dorm Rooms / Private Rooms) -->
                <template for:each={roomSections} for:item="section">
                    <div key={section.key}>
                        <h2 class="section-header">{section.label}</h2>
                        <template for:each={section.rooms} for:item="room">
                            <div key={room.productId} class={room.cardClass}>
                                <!-- Room Row -->
                                <lightning-layout vertical-align="center" class="room-row">
                                    <!-- Checkbox -->
                                    <lightning-layout-item class="slds-p-right_small">
                                        <lightning-input
                                            type="checkbox"
                                            checked={room.isSelected}
                                            data-id={room.productId}
                                            onchange={handleToggleSelect}
                                            variant="label-hidden"
                                            label="Select"
                                        ></lightning-input>
                                    </lightning-layout-item>
                                    <!-- Gender + Availability -->
                                    <lightning-layout-item class="icon-avail-col">
                                        <div class={room.genderClass}>
                                            <template for:each={room.genderIcons} for:item="gi">
                                                <lightning-icon key={gi.key} icon-name="utility:user" size="x-small"></lightning-icon>
                                            </template>
                                        </div>
                                        <div class={room.availClass}>{room.availLabel}</div>
                                    </lightning-layout-item>
                                    <!-- Name + Expand -->
                                    <lightning-layout-item flexibility="auto, grow" class="slds-p-horizontal_small">
                                        <span class="room-name">{room.name}</span>
                                        <button class="expand-btn" data-id={room.productId} onclick={handleToggleExpand}>
                                            <lightning-icon icon-name={room.chevronIcon} size="xx-small"></lightning-icon>
                                        </button>
                                    </lightning-layout-item>
                                    <!-- Rate -->
                                    <lightning-layout-item class="rate-col slds-text-align_right">
                                        <div class="rate-subtext">RATES STARTING FROM</div>
                                        <div class="rate-subtext">{room.formattedRate} {room.rateLabel}</div>
                                        <div class="rate-subtext">PER NIGHT</div>
                                    </lightning-layout-item>
                                    <!-- Price -->
                                    <lightning-layout-item class="price-col slds-text-align_right slds-p-left_small">
                                        <span class="price-dollars">{room.priceDollars}</span><sup class="price-cents">{room.priceCents}</sup>
                                    </lightning-layout-item>
                                </lightning-layout>

                                <!-- Expanded Detail -->
                                <template lwc:if={room.isExpanded}>
                                    <div class="room-detail">
                                        <lightning-layout>
                                            <template lwc:if={room.hasImage}>
                                                <lightning-layout-item size="5" padding="around-small">
                                                    <img src={room.imageUrl} alt={room.name} class="room-image"/>
                                                </lightning-layout-item>
                                            </template>
                                            <lightning-layout-item flexibility="auto, grow" padding="around-small">
                                                <template lwc:if={room.hasAmenities}>
                                                    <ul class="amenities-list">
                                                        <template for:each={room.amenitiesList} for:item="amenity">
                                                            <li key={amenity.key}>{amenity.text}</li>
                                                        </template>
                                                    </ul>
                                                </template>
                                            </lightning-layout-item>
                                        </lightning-layout>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>

            </lightning-layout-item>

            <!-- Right Column: Sidebar -->
            <lightning-layout-item size="4" padding="around-small">
                <div class="sidebar">

                    <!-- Date Pickers header (only when cart empty) -->
                    <template lwc:if={hasNoCartItems}>
                        <h3 class="sidebar-title">Current dates</h3>
                    </template>

                    <div class="slds-p-bottom_small">
                        <lightning-input
                            type="date"
                            label="Check in"
                            value={checkInDate}
                            onchange={handleCheckInChange}
                        ></lightning-input>
                    </div>
                    <div class="slds-p-bottom_small">
                        <lightning-input
                            type="date"
                            label="Check out"
                            value={checkOutDate}
                            onchange={handleCheckOutChange}
                        ></lightning-input>
                    </div>
                    <div class="slds-p-bottom_medium">
                        <lightning-combobox
                            label="Guests"
                            value={guestCount}
                            options={guestOptions}
                            onchange={handleGuestChange}
                        ></lightning-combobox>
                    </div>

                    <!-- Cart Items -->
                    <template lwc:if={hasCartItems}>
                        <template for:each={enrichedCartItems} for:item="item">
                            <div key={item.productId} class="cart-item">
                                <div class="cart-item-header">
                                    <button class="remove-btn" data-id={item.productId} onclick={handleRemoveItem}>
                                        REMOVE
                                        <lightning-icon icon-name="utility:close" size="xx-small" class="slds-p-left_xx-small"></lightning-icon>
                                    </button>
                                </div>
                                <div class="cart-item-name">{item.name}</div>
                                <lightning-layout vertical-align="center">
                                    <lightning-layout-item flexibility="auto, grow">
                                        <span class="cart-dates">{item.dateRange}</span>
                                    </lightning-layout-item>
                                    <lightning-layout-item>
                                        <span class="cart-nights">{item.nightCount}</span>
                                    </lightning-layout-item>
                                </lightning-layout>
                                <lightning-layout vertical-align="end" class="slds-p-top_small">
                                    <lightning-layout-item size="6">
                                        <lightning-combobox
                                            label={item.qtyFieldLabel}
                                            value={item.quantityStr}
                                            options={item.qtyOptions}
                                            data-id={item.productId}
                                            onchange={handleCartQuantityChange}
                                        ></lightning-combobox>
                                    </lightning-layout-item>
                                    <lightning-layout-item flexibility="auto, grow" class="slds-text-align_right">
                                        <span class="cart-item-price">{item.formattedTotal}</span>
                                    </lightning-layout-item>
                                </lightning-layout>
                                <div class="cart-qty-label">{item.qtyLabel}</div>
                            </div>
                        </template>
                    </template>

                </div>
            </lightning-layout-item>

        </lightning-layout>
    </div>
</template>
